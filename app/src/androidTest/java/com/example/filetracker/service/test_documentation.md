# Тесты для FileObserverWrapper.kt

Этот набор тестов предназначен для комплексной проверки функциональности класса
`LatestFolderWatcher` из файла `FileObserverWrapper.kt`.

## Структура тестов

### 1. LatestFolderWatcherTest (основные функциональные тесты)

- **Инициализация**: Проверка корректного создания экземпляров с различными параметрами
- **Управление жизненным циклом**: Тестирование `startWatching()` и `stopWatching()`
- **Работа с подпапками**: Проверка режима `watchSubfolders = true`
- **Работа с файлами в корневой папке**: Проверка режима `watchSubfolders = false`
- **Обработка существующих файлов**: Проверка копирования файлов при запуске
- **Обработка .nomedia файлов**: Проверка игнорирования служебных файлов
- **Лимит файлов**: Проверка обработки только 20 новейших файлов

### 2. LatestFolderWatcherEdgeCasesTest (граничные случаи)

- **Специальные символы**: Работа с путями, содержащими пробелы, дефисы, точки
- **Длинные имена файлов**: Обработка файлов с очень длинными именами
- **Глубокая вложенность**: Работа с глубоко вложенными структурами папок
- **Файлы только для чтения**: Обработка файлов с ограниченными правами
- **Символические ссылки**: Работа с симлинками (где поддерживается)
- **Concurrent операции**: Одновременные операции start/stop
- **Использование памяти**: Контроль потребления памяти при большом количестве файлов
- **Скрытые файлы**: Обработка файлов и папок, начинающихся с точки

### 3. FileObserverCreationTest (тесты создания FileObserver)

- **API совместимость**: Тестирование на разных версиях Android API
- **Различные маски событий**: Проверка работы с разными типами событий
- **Некорректные пути**: Обработка несуществующих или недоступных путей

### 4. FileSystemOperationsTest (файловые операции)

- **Создание файлов**: Детекция создания новых файлов
- **Создание папок**: Обнаружение новых подпапок
- **Переключение на новейшую папку**: Автоматическое переключение на алфавитно последнюю папку
- **Перемещение файлов**: Обработка операций move
- **Быстрые изменения**: Создание и удаление файлов в быстрой последовательности
- **Изменение прав доступа**: Реакция на изменения разрешений файлов
- **Переименование папок**: Обработка переименования директорий

### 5. FileObserverLoggingTest (тесты логирования)

- **Расширенное логирование**: Проверка работы с включенным extended logging
- **Обычное логирование**: Работа с отключенным extended logging
- **Логирование ошибок**: Корректное логирование при сбоях проверки условий
- **Содержимое логов**: Проверка корректности информации в логах

### 6. FileObserverConfigurationTest (конфигурация FileObserver)

- **Маски событий**: Работа с различными комбинациями событий
- **Параметры callback**: Корректная передача параметров в callback функции
- **Обработка ошибок**: Graceful handling некорректных конфигураций

### 7. FileObserverStressTest (стресс-тесты)

- **Множественные watchers**: Одновременная работа нескольких экземпляров
- **Быстрые циклы start/stop**: Устойчивость к частым перезапускам
- **Большие структуры**: Работа с глубокими деревьями папок
- **Контроль памяти**: Мониторинг использования памяти во времени
- **Обработка исключений**: Устойчивость к сбоям в процессе работы

### 8. FileObserverRealFileSystemTest (интеграционные тесты)

- **Реальное копирование файлов**: Тестирование с фактическим копированием файлов
- **Переключение между папками**: Интеграционная проверка смены отслеживаемых папок
- **Проверка содержимого**: Верификация корректности скопированного содержимого
- **Бинарные файлы**: Работа с нетекстовыми файлами

## Настройка зависимостей

Для запуска тестов необходимо добавить в `build.gradle` (app level):

```gradle
android {
    testOptions {
        unitTests {
            includeAndroidResources = true
        }
    }
}

dependencies {
    // Основные тестовые зависимости
    testImplementation 'junit:junit:4.13.2'
    testImplementation 'org.jetbrains.kotlinx:kotlinx-coroutines-test:1.6.4'
    
    // Robolectric для Android тестов
    testImplementation 'org.robolectric:robolectric:4.10.3'
    
    // MockK для мокирования
    testImplementation 'io.mockk:mockk:1.13.5'
    testImplementation 'io.mockk:mockk-android:1.13.5'
    
    // Kotlin test
    testImplementation 'org.jetbrains.kotlin:kotlin-test:1.8.10'
    
    // AndroidX тестовые утилиты
    testImplementation 'androidx.test:core:1.5.0'
    testImplementation 'androidx.arch.core:core-testing:2.2.0'
}
```

## Запуск тестов

### Все тесты

```bash
./gradlew test
```

### Конкретный тестовый класс

```bash
./gradlew test --tests "com.example.filetracker.service.LatestFolderWatcherTest"
```

### Конкретный тест

```bash
./gradlew test --tests "com.example.filetracker.service.LatestFolderWatcherTest.test startWatching with existing subfolders"
```

### С подробным выводом

```bash
./gradlew test --info
```

## Моки и их назначение

### FitTracker

Мокируется для предоставления контекста приложения, необходимого для EventLogger.

### Context

Мокируется для имитации Android контекста, включая SharedPreferences.

### AppDatabase и EventLogDao

Мокируются для перехвата операций логирования без реального обращения к базе данных.

### FileUtils

Мокируется для контроля операций проверки условий файлов и копирования.

## Особенности тестирования

### Временные директории

Каждый тест создает временные директории, которые автоматически удаляются после завершения теста.

### Асинхронность

Тесты используют `runBlockingTest` и `delay()` для учета асинхронных операций FileObserver.

### Изоляция

Каждый тест полностью изолирован с помощью `@Before` и `@After` методов.

### Память

Стресс-тесты включают проверки использования памяти для предотвращения утечек.

## Проблемы и ограничения

### FileObserver в тестах

В unit-тестовой среде FileObserver может не генерировать реальные события файловой системы. Тесты
проверяют главным образом логику инициализации и обработки.

### Временные метки

Тесты используют небольшие задержки (`delay()`) для имитации различий во времени создания файлов.

### Файловая система

Некоторые тесты (например, с символическими ссылками) могут не работать на всех файловых системах.

## Метрики производительности

Тесты включают измерения:

- Время запуска watcher'а
- Время остановки watcher'а
- Использование памяти
- Время обработки большого количества файлов

## Отладка

Для отладки тестов можно:

1. Увеличить задержки в `delay()` вызовах
2. Добавить дополнительное логирование
3. Использовать `--info` флаг при запуске тестов
4. Проверить содержимое временных директорий (перед их удалением)

## Расширение тестов

При добавлении новой функциональности в `LatestFolderWatcher`:

1. Добавьте unit-тесты в соответствующий тестовый класс
2. Убедитесь в покрытии граничных случаев
3. Добавьте стресс-тесты для ресурсоемких операций
4. Проверьте интеграцию с реальной файловой системой
5. Обновите документацию

## Continuous Integration

Тесты должны выполняться в CI/CD pipeline:

```yaml
# Пример для GitHub Actions
- name: Run Unit Tests
  run: ./gradlew test --stacktrace

- name: Upload Test Results
  uses: actions/upload-artifact@v3
  if: always()
  with:
    name: test-results
    path: app/build/reports/tests/
```

## Покрытие кода

Для анализа покрытия кода тестами:

```gradle
android {
    buildTypes {
        debug {
            testCoverageEnabled true
        }
    }
}
```

```bash
./gradlew createDebugCoverageReport
```